<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Управление доступами</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.5;
            margin: 0;
            padding: 16px;
            color: var(--tg-theme-text-color, #000000);
            background-color: var(--tg-theme-bg-color, #ffffff);
        }
        h1 {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 24px;
            text-align: center;
            color: var(--tg-theme-text-color, #000000);
        }
        .user-container {
            margin-bottom: 20px;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 8px;
            padding: 12px;
        }
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
        }
        .user-projects {
            display: none;
            margin-top: 10px;
        }
        .project-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--tg-theme-hint-color, #cccccc);
        }
        .project-item:last-child {
            border-bottom: none;
        }
        select {
            padding: 6px;
            border-radius: 4px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        #loading, #error-message {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: var(--tg-theme-hint-color, #999999);
        }
        #error-message {
            color: #ff0000;
        }
    </style>
</head>
<body>
    <h1>Управление доступами</h1>
    <div id="loading">Загрузка данных...</div>
    <div id="error-message" style="display:none;"></div>
    <div id="users-container"></div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.setText("Назад").show().onClick(function(){ window.location.href = 'index.html'; });

        let accessData = [];

        async function fetchData() {
            const userId = tg.initDataUnsafe?.user?.id;
            const username = tg.initDataUnsafe?.user?.username;
            
            if (!userId) {
                throw new Error('Не удалось получить ID пользователя');
            }

            try {
                const response = await fetch(`https://n8n61-fa4ea4ac7379.herokuapp.com/webhook-test/kpi-checker-web?userId=${userId}&username=${username}&page=access-management&action=get-data`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (!Array.isArray(data) || data.length === 0 || !data[0].access_table) {
                    throw new Error('Неверный формат данных или пустой массив');
                }
                return data[0].access_table;
            } catch (error) {
                console.error("Ошибка при загрузке данных:", error);
                throw error;
            }
        }

        function createUserList(data) {
            const container = document.getElementById('users-container');
            container.innerHTML = '';

            data.forEach(user => {
                const userContainer = document.createElement('div');
                userContainer.className = 'user-container';

                const userHeader = document.createElement('div');
                userHeader.className = 'user-header';
                userHeader.innerHTML = `
                    <span>${user.username}</span>
                    <span>▼</span>
                `;
                userHeader.onclick = () => toggleProjects(userContainer);

                const userProjects = document.createElement('div');
                userProjects.className = 'user-projects';

                user.project_access.forEach(project => {
                    const projectItem = document.createElement('div');
                    projectItem.className = 'project-item';
                    projectItem.innerHTML = `
                        <span>${project.project_name}</span>
                        <select onchange="updateAccess('${user.chat_id}', '${project.project_id}', this.value)">
                            <option value="user_access" ${project.access_type === 'user_access' ? 'selected' : ''}>User Access</option>
                            <option value="promo_access" ${project.access_type === 'promo_access' ? 'selected' : ''}>Promo Access</option>
                            <option value="full_access" ${project.access_type === 'full_access' ? 'selected' : ''}>Full Access</option>
                        </select>
                    `;
                    userProjects.appendChild(projectItem);
                });

                userContainer.appendChild(userHeader);
                userContainer.appendChild(userProjects);
                container.appendChild(userContainer);
            });
        }

        function toggleProjects(userContainer) {
            const projectsDiv = userContainer.querySelector('.user-projects');
            const arrow = userContainer.querySelector('.user-header span:last-child');
            if (projectsDiv.style.display === 'none' || projectsDiv.style.display === '') {
                projectsDiv.style.display = 'block';
                arrow.textContent = '▲';
            } else {
                projectsDiv.style.display = 'none';
                arrow.textContent = '▼';
            }
        }

        async function updateAccess(chatId, projectId, newAccessType) {
            const tgUserId = tg.initDataUnsafe?.user?.id;
            const tgUsername = tg.initDataUnsafe?.user?.username;

            try {
                const response = await fetch(`https://n8n61-fa4ea4ac7379.herokuapp.com/webhook-test/kpi-checker-web?userId=${tgUserId}&username=${tgUsername}&page=access-management&action=update-access`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chatId: chatId,
                        projectId: projectId,
                        accessType: newAccessType
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || 'Неизвестная ошибка при обновлении доступа');
                }

                tg.showAlert('Доступ успешно обновлен');
            } catch (error) {
                console.error('Ошибка при обновлении доступа:', error);
                tg.showAlert(`Ошибка при обновлении доступа: ${error.message}`);
            }
        }

        window.onload = async function() {
            try {
                accessData = await fetchData();
                createUserList(accessData);
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('error-message').textContent = `Ошибка: ${error.message}`;
                console.error("Подробности ошибки:", error);
            }
        };
    </script>
</body>
</html>
